<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ORID æ•™å¸«è§€èª²èˆ‡è­°èª²çŸ©é™£ (æœ€çµ‚ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --header-bg: #475569;
            --header-text: #f8fafc;
            --cell-bg: #ffffff;
        }

        body {
            overscroll-behavior: none;
            overflow: hidden;
            user-select: none;
            touch-action: none;
            font-family: system-ui, -apple-system, sans-serif;
        }

        /* --- 1. çŸ©é™£ç¶²æ ¼è¨­å®š --- */
        .matrix-grid {
            display: grid;
            grid-template-columns: 110px repeat(4, 1fr);
            grid-template-rows: 80px repeat(4, 1fr);
            gap: 2px;
            background-color: #cbd5e1;
            height: 100vh;
            width: 100vw;
            position: absolute;
            top: 0; left: 0;
            z-index: 10;
        }

        .matrix-cell {
            background-color: var(--cell-bg);
            padding: 4px;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        /* è¡¨é ­ */
        .header-col {
            background-color: var(--header-bg);
            color: var(--header-text);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-weight: bold; text-align: center; padding: 5px; line-height: 1.2;
        }
        .header-row {
            background-color: var(--header-bg);
            color: var(--header-text);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; padding: 4px; line-height: 1.1;
        }
        .header-subtitle { font-size: 0.65rem; font-weight: normal; opacity: 0.9; margin-top: 2px; }
        .corner-cell { background-color: #334155; z-index: 15; }

        /* --- 2. å¡ç‰‡æ¨£å¼ --- */
        .note-card {
            flex: 1 1 auto;
            min-height: 0;
            border: 1px solid #cbd5e1;
            background-color: transparent;
            border-radius: 4px;
            padding: 2px 4px;
            position: relative;
            transition: transform 0.2s, box-shadow 0.2s, background-color 0.2s;
            display: flex; align-items: center; justify-content: flex-start; text-align: left;
            cursor: pointer;
            z-index: 11;
        }
        .note-card:active { cursor: grabbing; }
        .note-card.selected { 
            border: 2px solid #3b82f6 !important; 
            background-color: rgba(59, 130, 246, 0.05);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); 
        }
        .note-card.editing {
            background-color: #fff; border-color: #3b82f6; z-index: 100; cursor: text;
        }

        .highlight-yellow { background-color: rgba(254, 249, 195, 0.7) !important; border-color: #eab308 !important; }
        .highlight-green { background-color: rgba(220, 252, 231, 0.7) !important; border-color: #22c55e !important; }
        .highlight-blue { background-color: rgba(219, 234, 254, 0.7) !important; border-color: #3b82f6 !important; }

        .note-content-wrapper { width: 100%; overflow: hidden; display: block; text-align: left; word-break: break-all; white-space: normal; font-size: 12px; line-height: 1.3; }
        .note-content-wrapper span[contenteditable="true"] { 
            outline: none; background-color: rgba(255, 255, 255, 0.9); cursor: text; min-width: 20px; display: inline-block; padding: 2px;
        }
        .note-id-badge { font-weight: bold; margin-right: 4px; opacity: 0.7; font-size: 0.9em; }

        /* å­—é«”è‡ªå‹•ç¸®å° */
        .matrix-cell[data-density="level-2"] .note-content-wrapper { font-size: 11px; line-height: 1.25; }
        .matrix-cell[data-density="level-3"] .note-content-wrapper { font-size: 10px; line-height: 1.2; }
        .matrix-cell[data-density="level-4"] .note-content-wrapper { font-size: 9px; line-height: 1.15; padding: 1px 0; }
        .matrix-cell[data-density="level-5"] .note-content-wrapper { font-size: 8px; line-height: 1.1; padding: 0; }

        /* --- 3. æ‰‹ç¹ªåœ–å±¤ --- */
        #drawing-canvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 50; pointer-events: none; touch-action: none;
        }
        body.drawing-mode #drawing-canvas { pointer-events: auto; cursor: crosshair; }

        /* --- 4. åœ–ç‰‡ç‰©ä»¶ --- */
        .image-wrapper {
            position: absolute; z-index: 40; padding: 0; cursor: move;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: 2px solid white;
            min-width: 50px; min-height: 50px; transition: box-shadow 0.2s;
        }
        .image-wrapper.selected { border: 2px solid #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3); }
        .image-wrapper img { width: 100%; height: 100%; object-fit: cover; pointer-events: none; }
        .resize-handle {
            position: absolute; bottom: 0; right: 0; width: 30px; height: 30px;
            background: linear-gradient(135deg, transparent 50%, #3b82f6 50%);
            cursor: nwse-resize; z-index: 41;
        }
        .image-wrapper.maximized {
            position: fixed !important; top: 50% !important; left: 50% !important;
            transform: translate(-50%, -50%) !important;
            width: 90vw !important; height: auto !important; max-height: 90vh;
            z-index: 1000 !important; border: 5px solid white;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); cursor: zoom-out;
        }
        .image-wrapper.maximized .resize-handle { display: none; }

        /* --- 5. æ”¾å¤§æµ®å‹•è¦–çª— --- */
        #zoom-overlay {
            position: absolute; background-color: white; border: 2px solid #3b82f6;
            box-shadow: 0 10px 30px rgba(0,0,0,0.25); border-radius: 8px; padding: 20px;
            z-index: 500; display: flex; align-items: center; justify-content: center;
            text-align: center; font-size: 16px; font-weight: bold; color: #1e293b;
            cursor: pointer; white-space: normal; word-break: break-word; overflow-y: auto;
        }

        /* --- 6. UI å·¥å…·åˆ— --- */
        #input-toolbar {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 85%; max-width: 800px;
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(5px);
            border-radius: 12px; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2);
            z-index: 200; border: 1px solid #e2e8f0; display: flex; flex-direction: column;
        }
        #draw-toolbar {
            position: fixed; top: 20px; right: 20px; width: 60px;
            background: rgba(255, 255, 255, 0.95); border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15); z-index: 200; border: 1px solid #e2e8f0;
            display: flex; flex-direction: column; align-items: center;
            overflow: hidden; transition: height 0.3s, width 0.3s;
        }
        
        .toolbar-handle { cursor: grab; padding: 10px 0; background: #f1f5f9; width: 100%; text-align: center; font-size: 0.8rem; }
        
        .draw-btn { 
            width: 44px; height: 44px; margin: 4px; border-radius: 8px; 
            display: flex; align-items: center; justify-content: center; 
            cursor: pointer; border: 1px solid transparent; transition: all 0.1s;
        }
        .draw-btn:active { transform: scale(0.95); }
        .draw-btn.active { background-color: #bfdbfe; border-color: #3b82f6; }
        
        .color-dot { width: 24px; height: 24px; border-radius: 50%; border: 1px solid rgba(0,0,0,0.1); cursor: pointer; transform: scale(0.8); transition: transform 0.2s; }
        .color-dot.active { transform: scale(1.2); box-shadow: 0 0 0 2px white, 0 0 0 4px #3b82f6; }

        /* å³éµé¸å–® */
        #context-menu { display: none; position: absolute; z-index: 600; background-color: white; border: 1px solid #e2e8f0; border-radius: 6px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); padding: 4px; }
        .menu-item { display: flex; align-items: center; gap: 8px; padding: 10px 16px; cursor: pointer; border-radius: 4px; font-size: 14px; }
        .menu-item:hover { background-color: #f1f5f9; }

        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 4px; padding: 12px; position: fixed; z-index: 800; left: 50%; bottom: 120px; transform: translateX(-50%); opacity: 0; transition: opacity 0.3s; }
        #toast.show { visibility: visible; opacity: 1; }
        .hidden { display: none !important; }
    </style>
</head>
<body class="">

    <canvas id="drawing-canvas"></canvas>

    <div id="zoom-overlay" class="hidden" onclick="this.classList.add('hidden')">
        <span class="content"></span>
        <div class="absolute bottom-2 right-2 text-xs text-slate-400 font-normal">(é»æ“Šé—œé–‰)</div>
    </div>

    <div id="context-menu">
        <div class="menu-item" onclick="toggleCardZoom()"><span class="text-blue-500 font-bold">ğŸ” æ”¾å¤§æª¢è¦– (1.5x)</span></div>
        <hr class="my-1 border-slate-200">
        <div class="menu-item" onclick="applyHighlight('highlight-yellow')"><div class="color-dot bg-yellow-200"></div> æ·¡é»ƒæ¨™è¨˜</div>
        <div class="menu-item" onclick="applyHighlight('highlight-green')"><div class="color-dot bg-green-200"></div> æ·¡ç¶ æ¨™è¨˜</div>
        <div class="menu-item" onclick="applyHighlight('highlight-blue')"><div class="color-dot bg-blue-200"></div> æ·¡è—æ¨™è¨˜</div>
        <hr class="my-1 border-slate-200">
        <div class="menu-item text-red-500" onclick="deleteObjectContext()">ğŸ—‘ï¸ åˆªé™¤</div>
        <div class="menu-item text-slate-500" onclick="applyHighlight(null)">æ¸…é™¤æ¨™è¨˜</div>
    </div>

    <div id="toast">æç¤ºè¨Šæ¯</div>

    <div class="matrix-grid" id="matrix-container">
        <!-- è§’è½å€ -->
        <div class="corner-cell flex flex-col justify-between items-center text-white p-2">
            <div class="flex gap-1 w-full justify-center">
                <button onclick="exportData()" class="text-[10px] bg-slate-600 hover:bg-slate-500 px-2 py-1 rounded">åŒ¯å‡º</button>
                <button onclick="document.getElementById('file-input').click()" class="text-[10px] bg-slate-600 hover:bg-slate-500 px-2 py-1 rounded">åŒ¯å…¥</button>
                <input type="file" id="file-input" accept=".json" class="hidden" onchange="importData(event)">
            </div>
            <div class="text-lg font-bold mt-1">æ··åˆç™½æ¿</div>
        </div>
        
        <!-- Headers -->
        <div class="header-col bg-sky-700"><div>å®¢è§€äº‹å¯¦ <span class="text-yellow-300">O</span></div><div class="header-subtitle">Objective</div></div>
        <div class="header-col bg-emerald-700"><div>æ„Ÿå—åæ‡‰ <span class="text-yellow-300">R</span></div><div class="header-subtitle">Reflective</div></div>
        <div class="header-col bg-indigo-700"><div>è©®é‡‹æ„ç¾© <span class="text-yellow-300">I</span></div><div class="header-subtitle">Interpretive</div></div>
        <div class="header-col bg-rose-700"><div>æ±ºå®šè¡Œå‹• <span class="text-yellow-300">D</span></div><div class="header-subtitle">Decisional</div></div>

        <div class="header-row border-t border-slate-500"><span class="header-title">æ•™æ</span><span class="header-subtitle">èª²ç¨‹</span></div>
        <div class="matrix-cell" id="cell-0-0" data-dim="0" data-orid="0"></div>
        <div class="matrix-cell" id="cell-0-1" data-dim="0" data-orid="1"></div>
        <div class="matrix-cell" id="cell-0-2" data-dim="0" data-orid="2"></div>
        <div class="matrix-cell" id="cell-0-3" data-dim="0" data-orid="3"></div>
        
        <div class="header-row border-t border-slate-500"><span class="header-title">æ•™å­¸è€…</span><span class="header-subtitle">æ•™æ³•</span></div>
        <div class="matrix-cell" id="cell-1-0" data-dim="1" data-orid="0"></div>
        <div class="matrix-cell" id="cell-1-1" data-dim="1" data-orid="1"></div>
        <div class="matrix-cell" id="cell-1-2" data-dim="1" data-orid="2"></div>
        <div class="matrix-cell" id="cell-1-3" data-dim="1" data-orid="3"></div>
        
        <div class="header-row border-t border-slate-500"><span class="header-title">å­¸ç”Ÿ</span><span class="header-subtitle leading-tight">åƒèˆ‡ã€äº’å‹•</span></div>
        <div class="matrix-cell" id="cell-2-0" data-dim="2" data-orid="0"></div>
        <div class="matrix-cell" id="cell-2-1" data-dim="2" data-orid="1"></div>
        <div class="matrix-cell" id="cell-2-2" data-dim="2" data-orid="2"></div>
        <div class="matrix-cell" id="cell-2-3" data-dim="2" data-orid="3"></div>
        
        <div class="header-row border-t border-slate-500"><span class="header-title">æƒ…å¢ƒ</span><span class="header-subtitle leading-tight">ç’°å¢ƒã€è¨­å‚™</span></div>
        <div class="matrix-cell" id="cell-3-0" data-dim="3" data-orid="0"></div>
        <div class="matrix-cell" id="cell-3-1" data-dim="3" data-orid="1"></div>
        <div class="matrix-cell" id="cell-3-2" data-dim="3" data-orid="2"></div>
        <div class="matrix-cell" id="cell-3-3" data-dim="3" data-orid="3"></div>
    </div>

    <!-- æ‰‹ç¹ªå·¥å…·åˆ— -->
    <div id="draw-toolbar">
        <div class="toolbar-handle text-xs text-slate-500" id="draw-handle">ğŸ¨ å·¥å…·</div>
        <div class="flex flex-col items-center p-2 gap-2">
            <button class="draw-btn active" id="btn-pointer" onclick="setDrawMode('pointer')" title="æ“ä½œ"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122" /></svg></button>
            <button class="draw-btn" id="btn-pen" onclick="setDrawMode('pen')" title="ç•«ç­†"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg></button>
            <button class="draw-btn" id="btn-eraser" onclick="setDrawMode('eraser')" title="æ©¡çš®æ“¦"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor"><path d="M16.24 3.56l4.95 4.94c.78.79.78 2.05 0 2.84L12 20.53a4.008 4.008 0 01-5.66 0L2.81 17c-.78-.79-.78-2.05 0-2.84l10.6-10.6c.79-.78 2.05-.78 2.83 0zM4.22 15.58l3.54 3.53c.78.79 2.04.79 2.83 0l1.41-1.41-6.36-6.36-1.42 1.41c-.78.79-.78 2.05 0 2.83z"/></svg></button>
            
            <div class="w-full h-px bg-slate-200 my-1"></div>
            
            <div class="flex gap-2 flex-wrap justify-center w-full px-1">
                <div class="color-dot bg-red-500 active" onclick="setPenColor('#ef4444', this)" title="ç´…"></div>
                <div class="color-dot bg-blue-500" onclick="setPenColor('#3b82f6', this)" title="è—"></div>
                <div class="color-dot bg-yellow-400" onclick="setPenColor('#facc15', this)" title="é»ƒ"></div>
                <div class="color-dot bg-green-500" onclick="setPenColor('#22c55e', this)" title="ç¶ "></div>
            </div>
            
            <div class="w-full h-px bg-slate-200 my-1"></div>
            
            <button class="draw-btn" onclick="undoDraw()" title="å¾©åŸ (Undo)">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />
                </svg>
            </button>

            <button class="draw-btn text-red-500" onclick="clearCanvas()" title="å…¨éƒ¨æ¸…é™¤">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
            </button>
        </div>
    </div>

    <!-- è¼¸å…¥å·¥å…·åˆ— -->
    <div id="input-toolbar">
        <div class="toolbar-handle rounded-t-xl border-b border-slate-200 flex justify-between items-center" id="input-handle">
            <span class="text-sm font-semibold text-slate-500">âœï¸ è¼¸å…¥æ§åˆ¶å°</span>
            <div class="flex gap-2">
                 <label class="cursor-pointer text-slate-500 hover:text-blue-500" title="ä¸Šå‚³åœ–ç‰‡">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                    <input type="file" class="hidden" accept="image/*" onchange="handleImageUpload(event)">
                </label>
                <button onclick="this.closest('#input-toolbar').querySelector('.p-4').classList.toggle('hidden')" class="text-slate-400 hover:text-slate-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M14.707 5.293a1 1 0 010 1.414L8.414 12l6.293 6.293a1 1 0 11-1.414 1.414l-7-7a1 1 0 010-1.414l7-7a1 1 0 011.414 0z" clip-rule="evenodd" transform="rotate(-90 10 10)" /></svg>
                </button>
            </div>
        </div>
        <div class="p-4 flex flex-wrap gap-2 items-center bg-white rounded-b-xl">
            <input type="text" id="input-text" class="flex-grow px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" placeholder="è¼¸å…¥å…§å®¹..." autocomplete="off">
            <!-- ç§»é™¤ AI æŒ‰éˆ• -->
            <div class="flex gap-1">
                <select id="sel-dim" class="px-2 py-2 border border-slate-300 rounded-lg bg-slate-50 text-xs w-24"><option value="" disabled selected>é …åº¦</option><option value="0">æ•™æèˆ‡èª²ç¨‹</option><option value="1">æ•™å­¸è€…èˆ‡æ•™æ³•</option><option value="2">å­¸ç”Ÿèˆ‡å­¸ç¿’</option><option value="3">æƒ…å¢ƒèˆ‡ç’°å¢ƒ</option></select>
                <!-- æ›´æ–° ORID é¸å–® -->
                <select id="sel-orid" class="px-2 py-2 border border-slate-300 rounded-lg bg-slate-50 text-xs w-32">
                    <option value="" disabled selected>ORID</option>
                    <option value="0">O - å®¢è§€äº‹å¯¦</option>
                    <option value="1">R - æ„Ÿå—åæ‡‰</option>
                    <option value="2">I - è©®é‡‹æ„ç¾©</option>
                    <option value="3">D - æ±ºå®šè¡Œå‹•</option>
                </select>
            </div>
            <button id="btn-confirm" onclick="addNoteBtnClick()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-bold shadow-md active:scale-95 text-sm transition-colors">ç¢ºèª</button>
        </div>
    </div>

    <script>
        // Init
        let noteCounter = 0;
        let selectedNote = null;
        let selectedImage = null; 
        let contextMenuTargetId = null;
        let contextMenuTargetType = null;
        
        // Canvas & Undo History
        const canvas = document.getElementById('drawing-canvas');
        const ctx = canvas.getContext('2d');
        let isDrawing = false, drawMode = 'pointer', penColor = '#ef4444', penSize = 3;
        
        // å¾©åŸç³»çµ± (Undo System)
        let undoStack = [];
        const MAX_HISTORY = 20;

        function resizeCanvas() { 
            canvas.width = window.innerWidth; 
            canvas.height = window.innerHeight; 
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        function saveState() {
            if (undoStack.length >= MAX_HISTORY) undoStack.shift();
            undoStack.push(canvas.toDataURL());
        }

        function undoDraw() {
            if (undoStack.length > 0) {
                const lastState = undoStack.pop();
                const img = new Image();
                img.src = lastState;
                img.onload = function() {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0);
                };
            } else {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
        }

        // æ‹–æ›³ & ç¸®æ”¾ (ä¿®å¾©å¹³æ¿æ‹–æ›³å•é¡Œçš„æ ¸å¿ƒé‚è¼¯)
        function makeDraggable(element, handle, isResize = false) {
            let isDragging = false;
            let startX, startY, initialValX, initialValY;

            const start = (e) => {
                if (e.target.closest('button') || e.target.closest('input') || e.target.closest('select') || e.target.closest('label')) return;
                
                if (e.type === 'mousedown' && e.button !== 0) return;

                if(isResize) e.stopPropagation();
                
                if (element.classList.contains('maximized')) return;

                if(e.cancelable) e.preventDefault();

                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;

                isDragging = true;
                startX = clientX;
                startY = clientY;

                if (isResize) {
                    initialValX = element.offsetWidth;
                    initialValY = element.offsetHeight;
                } else {
                    const rect = element.getBoundingClientRect();
                    element.style.bottom = 'auto'; element.style.right = 'auto';
                    element.style.left = rect.left + 'px'; element.style.top = rect.top + 'px';
                    element.style.transform = 'none';
                    initialValX = rect.left;
                    initialValY = rect.top;
                }
            };

            const move = (e) => {
                if (!isDragging) return;
                e.preventDefault();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                const dx = clientX - startX;
                const dy = clientY - startY;

                if (isResize) {
                    element.style.width = `${Math.max(50, initialValX + dx)}px`;
                    element.style.height = `${Math.max(50, initialValY + dy)}px`;
                } else {
                    element.style.left = `${initialValX + dx}px`;
                    element.style.top = `${initialValY + dy}px`;
                }
            };
            const end = () => { isDragging = false; };

            handle.addEventListener('mousedown', start);
            document.addEventListener('mousemove', move);
            document.addEventListener('mouseup', end);

            handle.addEventListener('touchstart', start, { passive: false });
            document.addEventListener('touchmove', move, { passive: false });
            document.addEventListener('touchend', end);
        }

        makeDraggable(document.getElementById('input-toolbar'), document.getElementById('input-handle'));
        makeDraggable(document.getElementById('draw-toolbar'), document.getElementById('draw-handle'));

        // Drawing Logic
        function setDrawMode(mode) {
            drawMode = mode;
            document.querySelectorAll('.draw-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-' + mode).classList.add('active');
            if (mode === 'pointer') {
                document.body.classList.remove('drawing-mode');
            } else {
                document.body.classList.add('drawing-mode');
                ctx.globalCompositeOperation = (mode === 'eraser') ? 'destination-out' : 'source-over';
                ctx.lineWidth = (mode === 'eraser') ? 20 : penSize;
                ctx.globalAlpha = (mode === 'eraser') ? 1.0 : 0.7;
                ctx.strokeStyle = penColor;
                ctx.lineCap = 'round'; ctx.lineJoin = 'round';
            }
        }
        function setPenColor(color, el) {
            penColor = color;
            document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('active'));
            el.classList.add('active');
            if (drawMode !== 'eraser') { 
                ctx.strokeStyle = color; 
                ctx.globalAlpha = 0.7; 
                setDrawMode('pen'); 
            }
        }
        function clearCanvas() { 
            if(confirm('æ¸…é™¤æ‰€æœ‰ç•«å¸ƒå…§å®¹ï¼Ÿ(ä¸å¯å¾©åŸ)')) {
                ctx.clearRect(0, 0, canvas.width, canvas.height); 
                undoStack = []; 
            }
        }

        function startDrawing(e) { 
            if (drawMode === 'pointer') return; 
            isDrawing = true; 
            saveState(); 
            const pos = getPos(e); 
            ctx.beginPath(); ctx.moveTo(pos.x, pos.y); e.preventDefault(); 
        }
        function draw(e) { 
            if (!isDrawing || drawMode === 'pointer') return; 
            const pos = getPos(e); 
            ctx.lineTo(pos.x, pos.y); ctx.stroke(); e.preventDefault(); 
        }
        function stopDrawing() { isDrawing = false; ctx.beginPath(); }
        function getPos(e) {
            const r = canvas.getBoundingClientRect();
            const cx = e.touches ? e.touches[0].clientX : e.clientX;
            const cy = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: cx - r.left, y: cy - r.top };
        }
        canvas.addEventListener('mousedown', startDrawing); canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing); canvas.addEventListener('mouseout', stopDrawing);
        canvas.addEventListener('touchstart', startDrawing, { passive: false }); canvas.addEventListener('touchmove', draw, { passive: false }); canvas.addEventListener('touchend', stopDrawing);

        // Images
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) { createFloatingImage(e.target.result); };
            reader.readAsDataURL(file);
            event.target.value = '';
        }

        function createFloatingImage(src) {
            const wrapper = document.createElement('div');
            wrapper.className = 'image-wrapper';
            wrapper.id = 'img-' + Date.now();
            wrapper.style.left = (window.innerWidth/2 - 75) + 'px';
            wrapper.style.top = (window.innerHeight/2 - 75) + 'px';
            wrapper.style.width = '150px';
            wrapper.style.height = '150px';

            const img = document.createElement('img');
            img.src = src;

            const resizeHandle = document.createElement('div');
            resizeHandle.className = 'resize-handle';

            wrapper.appendChild(img);
            wrapper.appendChild(resizeHandle);
            document.body.appendChild(wrapper);

            makeDraggable(wrapper, wrapper);
            makeDraggable(wrapper, resizeHandle, true);

            wrapper.addEventListener('mousedown', function(e) {
                if(e.target === resizeHandle) return;
                selectImage(this);
            });

            wrapper.addEventListener('dblclick', function() { 
                if (this.classList.contains('maximized')) {
                    this.classList.remove('maximized');
                    if (this.dataset.prevLeft) {
                        this.style.left = this.dataset.prevLeft;
                        this.style.top = this.dataset.prevTop;
                        this.style.width = this.dataset.prevWidth;
                        this.style.height = this.dataset.prevHeight;
                        this.style.transform = 'none';
                    }
                } else {
                    this.dataset.prevLeft = this.style.left;
                    this.dataset.prevTop = this.style.top;
                    this.dataset.prevWidth = this.style.width;
                    this.dataset.prevHeight = this.style.height;
                    this.classList.add('maximized');
                }
            });

            wrapper.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                selectImage(this);
                contextMenuTargetId = this.id;
                contextMenuTargetType = 'image';
                showContextMenu(e.pageX, e.pageY);
            });
        }

        function selectImage(imgWrapper) {
            if(selectedImage) selectedImage.classList.remove('selected');
            deselectNote(); 
            selectedImage = imgWrapper;
            selectedImage.classList.add('selected');
        }

        function deselectImage() {
            if(selectedImage) {
                selectedImage.classList.remove('selected');
                selectedImage = null;
            }
        }

        // App Interaction
        document.querySelectorAll('.matrix-cell').forEach(cell => {
            cell.addEventListener('dragover', e => e.preventDefault());
            cell.addEventListener('drop', handleDrop);
        });

        document.addEventListener('click', (e) => {
            document.getElementById("context-menu").style.display = "none";
            const target = e.target;
            const isNote = target.closest('.note-card');
            const isImage = target.closest('.image-wrapper');
            const isToolbar = target.closest('#input-toolbar') || target.closest('#draw-toolbar');
            const isMenu = target.closest('#context-menu');

            if (!isNote && !isToolbar && !isMenu) deselectNote();
            if (!isImage && !isToolbar && !isMenu) deselectImage();
        });

        document.addEventListener('keydown', (e) => {
            if (e.target.isContentEditable || e.target.tagName === 'INPUT') return;
            if (e.key === 'Delete' || e.key === 'Backspace') {
                if (selectedNote) { deleteNote(selectedNote); e.preventDefault(); } 
                else if (selectedImage) { deleteImage(selectedImage); e.preventDefault(); }
            }
        });

        function addNoteBtnClick() {
            const text = document.getElementById("input-text").value.trim();
            const dim = document.getElementById("sel-dim").value;
            const orid = document.getElementById("sel-orid").value;
            if (!text || dim === "" || orid === "") { showToast("è«‹è¼¸å…¥å…§å®¹èˆ‡åˆ†é¡"); return; }

            if (selectedNote) {
                selectedNote.querySelector('.note-content-wrapper span:last-child').innerText = text;
                const currentCell = selectedNote.parentElement;
                const targetCell = document.getElementById(`cell-${dim}-${orid}`);
                if (currentCell !== targetCell) {
                    targetCell.appendChild(selectedNote);
                    updateCellDensity(currentCell);
                    updateCellDensity(targetCell);
                }
                deselectNote();
                showToast("å·²ä¿®æ”¹");
            } else {
                createNoteElement(text, dim, orid);
                document.getElementById("input-text").value = "";
            }
        }

        function createNoteElement(text, dim, orid, id = null, highlightClass = null) {
            const targetCell = document.getElementById(`cell-${dim}-${orid}`);
            noteCounter = id ? Math.max(noteCounter, parseInt(id.split('-')[1])) : noteCounter + 1;
            const noteId = id || `note-${noteCounter}`;

            const note = document.createElement("div");
            note.className = "note-card";
            if (highlightClass) note.classList.add(highlightClass);
            note.id = noteId;
            note.draggable = true;
            note.innerHTML = `<div class="note-content-wrapper"><span class="note-id-badge">#${noteId.split('-')[1]}</span><span>${text.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</span></div>`;

            note.addEventListener('dragstart', handleDragStart);
            note.addEventListener('click', handleNoteClick);
            note.addEventListener('dblclick', handleNoteDblClick);
            note.addEventListener('contextmenu', handleContextMenu);
            note.addEventListener('touchstart', function(e) { if(drawMode==='pointer') e.stopPropagation(); }, {passive: false});

            targetCell.appendChild(note);
            updateCellDensity(targetCell); 
            return note;
        }

        function updateCellDensity(cell) {
            const count = cell.children.length;
            if (count > 12) cell.setAttribute('data-density', 'level-5');
            else if (count > 9) cell.setAttribute('data-density', 'level-4');
            else if (count > 6) cell.setAttribute('data-density', 'level-3');
            else if (count > 3) cell.setAttribute('data-density', 'level-2');
            else cell.removeAttribute('data-density');
        }

        function handleNoteClick(e) {
            e.stopPropagation();
            if(e.target.isContentEditable) return;
            selectNote(this);
        }

        function selectNote(note) {
            if (selectedNote) selectedNote.classList.remove('selected');
            deselectImage();
            selectedNote = note;
            selectedNote.classList.add('selected');

            const text = note.querySelector('.note-content-wrapper span:last-child').innerText;
            const cell = note.parentElement;
            document.getElementById("input-text").value = text;
            document.getElementById("sel-dim").value = cell.dataset.dim;
            document.getElementById("sel-orid").value = cell.dataset.orid;

            const btn = document.getElementById("btn-confirm");
            btn.innerText = "ä¿®æ”¹";
            btn.classList.remove("bg-blue-600", "hover:bg-blue-700");
            btn.classList.add("bg-green-600", "hover:bg-green-700");
        }

        function deselectNote() {
            if (selectedNote) {
                selectedNote.classList.remove('selected');
                selectedNote = null;
            }
            document.getElementById("input-text").value = "";
            document.getElementById("sel-dim").value = "";
            document.getElementById("sel-orid").value = "";
            const btn = document.getElementById("btn-confirm");
            btn.innerText = "ç¢ºèª";
            btn.classList.remove("bg-green-600", "hover:bg-green-700");
            btn.classList.add("bg-blue-600", "hover:bg-blue-700");
        }

        function handleNoteDblClick(e) {
            e.stopPropagation();
            const note = this;
            const textSpan = note.querySelector('.note-content-wrapper span:last-child');
            textSpan.contentEditable = true;
            textSpan.focus();
            note.draggable = false;
            note.classList.add('editing');

            const finishEdit = () => {
                textSpan.contentEditable = false;
                note.draggable = true;
                note.classList.remove('editing');
                textSpan.removeEventListener('blur', finishEdit);
                textSpan.removeEventListener('keydown', handleKey);
                if (selectedNote === note) document.getElementById("input-text").value = textSpan.innerText;
            };
            const handleKey = (e) => { if (e.key === 'Enter') { e.preventDefault(); textSpan.blur(); } };
            textSpan.addEventListener('blur', finishEdit);
            textSpan.addEventListener('keydown', handleKey);
        }

        function handleDragStart(e) { e.dataTransfer.setData('text/plain', e.target.id); deselectNote(); }
        function handleDrop(e) {
            e.preventDefault();
            const noteId = e.dataTransfer.getData('text/plain');
            if(!noteId) return;
            const note = document.getElementById(noteId);
            const targetCell = e.target.closest('.matrix-cell');
            if (note && targetCell && note.parentElement !== targetCell) {
                const oldCell = note.parentElement;
                targetCell.appendChild(note);
                updateCellDensity(oldCell);
                updateCellDensity(targetCell);
            }
        }

        function handleContextMenu(e) {
            e.preventDefault();
            selectNote(this);
            contextMenuTargetId = this.id;
            contextMenuTargetType = 'note';
            showContextMenu(e.pageX, e.pageY);
        }

        function showContextMenu(x, y) {
            const menu = document.getElementById("context-menu");
            menu.style.display = "block";
            const mx = Math.min(x, window.innerWidth - 150);
            const my = Math.min(y, window.innerHeight - 200);
            menu.style.left = `${mx}px`; menu.style.top = `${my}px`;
        }

        function toggleCardZoom() {
            if (contextMenuTargetType !== 'note') return;
            const note = document.getElementById(contextMenuTargetId);
            if (!note) return;
            
            const overlay = document.getElementById('zoom-overlay');
            const content = overlay.querySelector('.content');
            const text = note.querySelector('.note-content-wrapper span:last-child').innerText;
            content.innerText = text;

            const cell = note.parentElement;
            const rect = cell.getBoundingClientRect();
            
            const w = Math.min(window.innerWidth * 0.9, rect.width * 1.5);
            const h = Math.min(window.innerHeight * 0.9, rect.height * 1.5);
            
            overlay.style.width = w + 'px';
            overlay.style.height = h + 'px';
            overlay.style.fontSize = '32px'; 
            
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            
            overlay.style.left = (centerX - w/2) + 'px';
            overlay.style.top = (centerY - h/2) + 'px';
            
            overlay.classList.remove('hidden');
            document.getElementById("context-menu").style.display = "none";
        }

        function deleteObjectContext() {
            if (contextMenuTargetType === 'note') {
                const note = document.getElementById(contextMenuTargetId);
                if(note) deleteNote(note);
            } else if (contextMenuTargetType === 'image') {
                const img = document.getElementById(contextMenuTargetId);
                if(img) deleteImage(img);
            }
            document.getElementById("context-menu").style.display = "none";
        }
        function deleteNote(note) { const cell = note.parentElement; note.remove(); updateCellDensity(cell); selectedNote = null; showToast("å¡ç‰‡å·²åˆªé™¤"); deselectNote(); }
        function deleteImage(img) { img.remove(); selectedImage = null; showToast("åœ–ç‰‡å·²åˆªé™¤"); }
        
        function applyHighlight(colorClass) {
            if (contextMenuTargetType !== 'note') return;
            const note = document.getElementById(contextMenuTargetId);
            if (note) { note.classList.remove('highlight-yellow', 'highlight-green', 'highlight-blue'); if (colorClass) note.classList.add(colorClass); }
            document.getElementById("context-menu").style.display = "none";
        }

        function exportData() {
            const data = { notes: [], drawing: canvas.toDataURL() };
            document.querySelectorAll('.note-card').forEach(note => {
                const cell = note.parentElement;
                data.notes.push({
                    id: note.id,
                    text: note.querySelector('.note-content-wrapper span:last-child').innerText,
                    dim: cell.dataset.dim, orid: cell.dataset.orid,
                    highlight: Array.from(note.classList).find(c => c.startsWith('highlight-')) || null
                });
            });
            const dl = document.createElement('a');
            dl.setAttribute("href", "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data)));
            dl.setAttribute("download", "whiteboard_data.json");
            document.body.appendChild(dl); dl.click(); dl.remove();
            showToast("å·²åŒ¯å‡º");
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    document.querySelectorAll('.note-card').forEach(n => n.remove());
                    data.notes.forEach(n => createNoteElement(n.text, n.dim, n.orid, n.id, n.highlight));
                    if (data.drawing) { 
                        const img = new Image(); 
                        img.onload = function() { 
                            ctx.clearRect(0, 0, canvas.width, canvas.height);
                            ctx.drawImage(img, 0, 0); 
                            saveState(); // åŒ¯å…¥å¾Œå­˜æª”
                        }; 
                        img.src = data.drawing; 
                    }
                    showToast("åŒ¯å…¥æˆåŠŸ");
                } catch (err) { console.error(err); showToast("åŒ¯å…¥å¤±æ•—"); }
                event.target.value = '';
            };
            reader.readAsText(file);
        }
        function showToast(msg) { const t = document.getElementById("toast"); t.innerText = msg; t.className = "show"; setTimeout(() => t.className = "", 3000); }
    </script>
</body>
</html>
